---
- name: Detect the virtualisation engine
  block:
    - name: Load the kvm kernel module
      modprobe:
        name: kvm
      become: true
      failed_when: false

    - name: Check for the KVM device
      stat:
        path: /dev/kvm
      register: stat_kvm

    - name: Set a fact containing the virtualisation engine
      set_fact:
        libvirt_vm_engine: >-
          {%- if ansible_architecture != libvirt_vm_arch -%}
          {# Virtualisation instructions are generally available only for the host
          architecture. Ideally we would test for virtualisation instructions, eg. vt-d
          as it is possible that another architecture could support these even
          if the emulated cpu architecture is not the same. #}
          qemu
          {%- elif stat_kvm.stat.exists -%}
          kvm
          {%- else -%}
          qemu
          {%- endif -%}
  when: libvirt_vm_engine is none

- name: Detect the virtualisation emulator
  block:
    - name: Ensure old value stored in detected_libvirt_vm_emulator is cleared
      set_fact:
        detected_libvirt_vm_emulator: none

    - include_tasks: detect-kvm.yml
      when: libvirt_vm_engine == 'kvm'

    - block:
        - name: Detect the QEMU emulator binary path
          shell: which qemu-system-{{ libvirt_vm_arch }}
          register: qemu_emulator_result
          changed_when: false

        - name: Set a fact containing the QEMU emulator binary path
          set_fact:
            detected_libvirt_vm_emulator: "{{ qemu_emulator_result.stdout }}"

        - name: Override the QEMU emulator binary path on RedHat based distros
          # CentOS 7.5 ships qemu-system-x86-2.0.0-1.el7.6.x86_64, this
          # does not have smm support. We can use the qemu-kvm binary
          # from SIG virtualization repository.
          include_tasks: detect-kvm.yml
          when:
            - enable_feature_smm
            - ansible_os_family == "RedHat"
            - ansible_architecture == libvirt_vm_arch

      when: libvirt_vm_engine == 'qemu'

    - name: Fail if unable to detect the emulator
      fail:
        msg: Unable to detect emulator for engine {{ libvirt_vm_engine }}.
      when: detected_libvirt_vm_emulator is none
  when: libvirt_vm_emulator is none
